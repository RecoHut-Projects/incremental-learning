
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Neural Memory Streaming Recommender Networks with Adversarial Training &#8212; incremental-learning</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Incremental Collaborative Filtering" href="T993858_Incremental_Collaborative_Filtering.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">incremental-learning</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="L521041_Incremental_Learning.html">
   Incremental Learning
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Concepts
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="L194114_Concept_Drift.html">
   Concept Drift
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L589394_Jensen%E2%80%93Shannon_divergence.html">
   Jensen–Shannon divergence
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L241645_A_spectrum_of_model_freshness.html">
   A spectrum of model freshness
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L883094_Incremental_Learning_in_Computer_Vision.html">
   Incremental Learning in Computer Vision
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L369117_Incremental_Learning_in_Recommender_Systems.html">
   Incremental Learning in Recommender Systems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L725007_River.html">
   River
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L595800_Lambda_Learner.html">
   Lambda Learner
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L305905_Scikit_warm_start.html">
   Scikit warm-start
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Models
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="L498804_GLMix.html">
   GLMix
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L832818_IncCTR.html">
   IncCTR
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L753817_SML.html">
   SML
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L395827_CIGC.html">
   CIGC
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L958254_GraphSAIL.html">
   GraphSAIL
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L926913_NMRN.html">
   NMRN
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L766388_RKMF.html">
   RKMF
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Cases
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="L967738_MarketCloud.html">
   MarketCloud
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L593489_Huawei_AppGallery_Candidate_Selection_for_App_Recommendation.html">
   Huawei AppGallery Candidate Selection for App Recommendation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L576956_GLMix_in_LinkedIn_Job_Recommendation.html">
   GLMix in LinkedIn Job Recommendation
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Tutorials
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="T063084_Scikit_Multiflow.html">
   Scikit Multiflow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T578427_Dask_Incremental_Wrapper.html">
   Dask Incremental Wrapper
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T613575_Warm_start_Model_Retraining.html">
   Warm-start Model Retraining
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T502860_Drift_Detection_using_River_library.html">
   Drift Detection using River library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T664430_Incremental_Stochastic_Gradient_Descent.html">
   Incremental Stochastic Gradient Descent
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T860884_Avalanche_Visual_Incremental_Learning.html">
   Avalanche Visual Incremental Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T392297_Lambda_Learner_for_Incremental_Learning_using_GLMix_models.html">
   Lambda Learner for Incremental Learning using GLMix models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T007121_FlowRec.html">
   FlowRec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T012987_Incremental_Matrix_Factorization_on_ML_100k_using_River_library.html">
   Incremental Matrix Factorization on ML-100k using River library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T406689_Kernelized_Matrix_Factorization_on_ML_1m.html">
   Kernelized Matrix Factorization on ML-1m
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T993858_Incremental_Collaborative_Filtering.html">
   Incremental Collaborative Filtering
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Neural Memory Streaming Recommender Networks with Adversarial Training
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/T063788_Neural_Memory_Streaming_Recommender_Networks_with_Adversarial_Training.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/sparsh-ai/incremental-learning/main?urlpath=tree/docs/T063788_Neural_Memory_Streaming_Recommender_Networks_with_Adversarial_Training.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/sparsh-ai/incremental-learning/blob/main/docs/T063788_Neural_Memory_Streaming_Recommender_Networks_with_Adversarial_Training.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#training-procedure">
   Training procedure
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#links">
   Links
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="neural-memory-streaming-recommender-networks-with-adversarial-training">
<h1>Neural Memory Streaming Recommender Networks with Adversarial Training<a class="headerlink" href="#neural-memory-streaming-recommender-networks-with-adversarial-training" title="Permalink to this headline">¶</a></h1>
<p>NMRN is a streaming recommender model based on neural memory networks with external memories to capture and store both long-term stable interests and short-term dynamic interests in a unified way. An adaptive negative sampling framework based on Generative Adversarial Nets (GAN) is developed to optimize our proposed streaming recommender model, which effectively overcomes the limitations of classical negative sampling approaches and improves the effectiveness of the model parameter inference.</p>
<p><center><img src='_images/T063788_1.png'></center></p><p>Specifically, the external memories of NMRN compose the key memory and the value memory. Given a new user-item interaction pair(u , v) arriving at the system in real time, NMRN first generates a soft address from the key memory, activated by u. The addressing process is inspired by recent advances in attention mechanism. The attention mechanism applied in recommender systems is useful to improve the retrieval accuracy and model interpretability. The fundamental idea of this attention design is to learn a weighted representation across the key memory, which is converted into a probability distribution by the Softmax function as the soft address.Then, NMRN reads from the value memory based on the soft address, resulting in a vector that represents both long-term stable and short-term emerging interests of user u. Inspired by the success of pairwise personalized ranking models (e.g., BPR) in top-k recommendations, we adopt the Hinge-loss in our model optimization. As the number of unobserved examples is very huge, we use the negative sampling method to improve the training efficiency.</p>
<p>Most existing negative sampling approaches use either random sampling or popularity-biased sampling strategies. However, the majority of negative examples generated in these sampling strategies can be easily discriminated from observed examples, and will contribute little towards the training, because sampled items could be completely unrelated to the target user. Besides, these sampling approaches are not adaptive enough to generate adversarial negative examples, because (1) they are static and thus do not consider that the estimated similarity or proximity between a user and an item changes during the learning process. For example, the similarity between user u and a sampled noise item v is high at the beginning, but after several gradient descent steps it becomes low; and (2) these samplers are global and do not reflect how informative a noise item is w.r.t. a specific user.</p>
<p>In light of this, we use an adaptive noise sampler based on a Generative Adversarial Network (GAN) to optimize the model, which considers both the specific user and the current values of the model parameters to adaptively generate “difficult” and informative negative examples. Moreover, in order to simultaneously capture the first-order similarity between users and items as well as the second-order similarities between users and between items to learn robust representations of users and items, we use the Euclidean distance to measure the similarity between a user and an item instead of the widely adopted dot product.</p>
<p><center><img src='_images/T063788_2.png'></center></p><p>The Architecture of the model. The total numbers of users and items are denoted as <span class="math notranslate nohighlight">\(N\)</span> and <span class="math notranslate nohighlight">\(M\)</span>. We denote a user-item interaction pair at time <span class="math notranslate nohighlight">\(t\)</span> as <span class="math notranslate nohighlight">\((u_t , v_t)\)</span> while <span class="math notranslate nohighlight">\(v_t^-\)</span> is a sampled negative item for a specific user at time <span class="math notranslate nohighlight">\(t\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span> 
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span> 

<span class="kn">import</span> <span class="nn">torch</span> 
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">torch.optim</span> <span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span> <span class="nn">torch.nn.parameter</span> <span class="kn">import</span> <span class="n">Parameter</span>
<span class="kn">from</span> <span class="nn">torch.utils.data.dataset</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">torch.utils.data.dataloader</span> <span class="kn">import</span> <span class="n">DataLoader</span>

<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">log</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#some parameters of this model</span>
<span class="n">N</span><span class="p">,</span> <span class="n">D_in</span><span class="p">,</span> <span class="n">H</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span>
<span class="n">safety_margin_size</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">Max_sampleNum</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">total_item_num</span> <span class="o">=</span> <span class="mi">500</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">euclidean_distance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">value_memory</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">D_in</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">key_memory</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">D_in</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">D_in</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">D_in</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CandidateDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_data</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">len</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">my_dataset</span> <span class="o">=</span> <span class="n">CandidateDataset</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">my_dataset</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">generator</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">D_in</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">generator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D_in</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Prob of Left</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">cat_xy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">hidden1</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">cat_xy</span><span class="p">))</span>
        <span class="n">hidden2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">hidden1</span><span class="p">))</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fc3</span><span class="p">(</span><span class="n">hidden2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">output</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Discriminator</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">D_in</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">key_memory</span><span class="p">,</span> <span class="n">value_memory</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Discriminator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_memory</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">D_in</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value_memory</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">D_in</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_memory</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">key_memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value_memory</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">value_memory</span>
        <span class="c1">#self.value_memory.requires_grad=True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc_erase</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">D_in</span><span class="p">,</span> <span class="n">D_in</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc_update</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">D_in</span><span class="p">,</span> <span class="n">D_in</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">D_in</span> <span class="o">=</span> <span class="n">D_in</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">N</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">H</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">output_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">e_I</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">D_in</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
            <span class="c1">#Memory Adderssing</span>
            <span class="n">Attention_weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="p">):</span>
                <span class="n">Attention_weight</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">euclidean_distance</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_memory</span><span class="p">[</span><span class="n">j</span><span class="p">,:])</span>


            <span class="c1">#select value memory by attention</span>

            <span class="n">Attention_weight</span> <span class="o">=</span> <span class="n">Attention_weight</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">Attention_weight</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value_memory</span><span class="p">)</span>

            <span class="n">output</span> <span class="o">=</span> <span class="n">euclidean_distance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">output_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
            
            <span class="c1">#update value memory by item vector</span>
            <span class="n">e_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_erase</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value_memory</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_memory</span> <span class="o">*</span> <span class="p">(</span><span class="n">e_I</span> <span class="o">-</span> <span class="n">Attention_weight</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">t</span><span class="p">()</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">e_t</span><span class="p">))</span>

            <span class="n">a_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_update</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">tanh</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value_memory</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_memory</span> <span class="o">+</span> <span class="n">Attention_weight</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">t</span><span class="p">()</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">a_t</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">output_list</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ngtv_spl_by_unifm_dist</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="n">ngtv_item</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">D_in</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ngtv_item</span>

<span class="k">def</span> <span class="nf">ngtv_spl_by_generator</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="n">ngtv_item_id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="n">prob_ngtv_item</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">replacement</span><span class="o">=</span><span class="kc">True</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ngtv_item</span> <span class="o">=</span> <span class="n">dict_item_id2vec</span><span class="p">[</span><span class="n">candidate_ngtv_item</span><span class="p">[</span><span class="n">ngtv_item_id</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">ngtv_item_id</span><span class="p">,</span> <span class="n">ngtv_item</span>

<span class="k">def</span> <span class="nf">G_pretrain_per_datapoint</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">generator</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="n">ngtv_item_id</span><span class="p">,</span> <span class="n">ngtv_item</span> <span class="o">=</span> <span class="n">generator</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">neg_rslt</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">ngtv_item</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">neg_rslt</span><span class="p">,</span> <span class="n">ngtv_item_id</span>

<span class="k">def</span> <span class="nf">D_pretrain_per_datapoint</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">generator</span><span class="p">):</span>
    <span class="n">ps_rslt</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">item</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Max_sampleNum</span><span class="p">):</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">log</span><span class="p">((</span><span class="n">total_item_num</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">neg_rslt</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">generator</span><span class="p">(</span><span class="n">user</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">weighted_hinge_loss</span><span class="p">(</span><span class="n">ps_rslt</span><span class="p">,</span> <span class="n">neg_rslt</span><span class="p">,</span> <span class="n">safety_margin_size</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">loss</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">loss</span>
    
<span class="k">def</span> <span class="nf">weighted_hinge_loss</span><span class="p">(</span><span class="n">ps_rslt</span><span class="p">,</span> <span class="n">neg_rslt</span><span class="p">,</span> <span class="n">safety_margin_size</span><span class="p">,</span> <span class="n">weight</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">safety_margin_size</span> <span class="o">+</span> <span class="n">ps_rslt</span> <span class="o">-</span> <span class="n">neg_rslt</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># pre-training of discriminator</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Discriminator</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">key_memory</span><span class="p">,</span> <span class="n">value_memory</span><span class="p">)</span>
<span class="n">total_loss</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span> <span class="mf">0.01</span><span class="p">)</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">epoch_loss</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">for</span> <span class="n">batch_id</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">losses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">D_pretrain_per_datapoint</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ngtv_spl_by_unifm_dist</span><span class="p">)</span>

        <span class="n">mini_batch_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>
        <span class="n">epoch_loss</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mini_batch_loss</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        
        <span class="n">model</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">mini_batch_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;epoch_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:  loss=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">epoch_loss</span><span class="p">))</span>
    <span class="n">total_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_loss</span><span class="p">)</span>    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>epoch_0:  loss=9162.51040649414
epoch_1:  loss=9512.62255859375
epoch_2:  loss=9214.800323486328
epoch_3:  loss=9504.176055908203
epoch_4:  loss=9284.231536865234
epoch_5:  loss=9422.251586914062
epoch_6:  loss=9421.282775878906
epoch_7:  loss=9396.276489257812
epoch_8:  loss=9390.662292480469
epoch_9:  loss=9425.124694824219
epoch_10:  loss=9205.153289794922
epoch_11:  loss=9452.185852050781
epoch_12:  loss=9485.987365722656
epoch_13:  loss=9410.585327148438
epoch_14:  loss=9127.744140625
epoch_15:  loss=9379.030639648438
epoch_16:  loss=9347.898803710938
epoch_17:  loss=9386.432373046875
epoch_18:  loss=9456.192657470703
epoch_19:  loss=9354.690643310547
epoch_20:  loss=9413.049743652344
epoch_21:  loss=9403.752807617188
epoch_22:  loss=9283.259490966797
epoch_23:  loss=9420.226654052734
epoch_24:  loss=9239.539581298828
epoch_25:  loss=9273.154418945312
epoch_26:  loss=9407.462158203125
epoch_27:  loss=9153.6669921875
epoch_28:  loss=9260.94091796875
epoch_29:  loss=9324.113006591797
epoch_30:  loss=9295.09634399414
epoch_31:  loss=9115.524719238281
epoch_32:  loss=9340.50634765625
epoch_33:  loss=9337.981170654297
epoch_34:  loss=9454.823944091797
epoch_35:  loss=9180.193145751953
epoch_36:  loss=9336.213897705078
epoch_37:  loss=9159.22543334961
epoch_38:  loss=9305.651489257812
epoch_39:  loss=9302.890197753906
epoch_40:  loss=9213.26058959961
epoch_41:  loss=9284.324493408203
epoch_42:  loss=9388.560913085938
epoch_43:  loss=9230.17855834961
epoch_44:  loss=9386.049102783203
epoch_45:  loss=9325.175659179688
epoch_46:  loss=9343.497131347656
epoch_47:  loss=9220.862823486328
epoch_48:  loss=9395.390197753906
epoch_49:  loss=9170.428771972656
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dict_user_id2vec</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">dict_item_id2vec</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">candidate_ngtv_item</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">prob_ngtv_item</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">candidate_ngtv_item</span><span class="p">:</span>
    <span class="n">dict_item_id2vec</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">item</span><span class="p">()]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="training-procedure">
<h2>Training procedure<a class="headerlink" href="#training-procedure" title="Permalink to this headline">¶</a></h2>
<p><center><img src='_images/T063788_3.png'></center></p><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#pre-training of generator</span>
<span class="n">gener</span> <span class="o">=</span> <span class="n">generator</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">total_reward</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">total_loss</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">optimizer_G</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">gener</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span> <span class="mf">0.01</span><span class="p">)</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">epoch_reward</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">epoch_loss</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">for</span> <span class="n">batch_id</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>
        <span class="n">reward</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">mini_batch_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="k">for</span> <span class="n">data_point</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="c1">#state = x[i]</span>
            <span class="c1">#action_pool = []</span>
            <span class="c1">#reward_pool = []</span>
            <span class="n">candidate_ngtv_item</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">prob_ngtv_item</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">candidate_ngtv_item</span><span class="p">:</span>
                <span class="n">dict_item_id2vec</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">item</span><span class="p">()]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">candidate_ngtv_item</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">prob_ngtv_item</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gener</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">data_point</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">dict_item_id2vec</span><span class="p">[</span><span class="n">candidate_ngtv_item</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()])</span>
            <span class="n">prob_ngtv_item</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">prob_ngtv_item</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">reward</span><span class="p">[</span><span class="n">data_point</span><span class="p">],</span> <span class="n">ngtv_item_id</span> <span class="o">=</span> <span class="n">G_pretrain_per_datapoint</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">data_point</span><span class="p">],</span> <span class="n">ngtv_spl_by_generator</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
            <span class="n">mini_batch_loss</span><span class="p">[</span><span class="n">data_point</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">reward</span><span class="p">[</span><span class="n">data_point</span><span class="p">])</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">prob_ngtv_item</span><span class="p">[</span><span class="n">ngtv_item_id</span><span class="p">])</span>
        <span class="n">rewards</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">reward</span><span class="p">)</span>
        <span class="n">mini_batch_losses</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mini_batch_loss</span><span class="p">)</span>
        <span class="n">epoch_loss</span> <span class="o">=</span> <span class="n">epoch</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">mini_batch_losses</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">epoch_reward</span> <span class="o">=</span> <span class="n">epoch</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">rewards</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        
        <span class="n">gener</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">mini_batch_losses</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer_G</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;epoch_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:  loss=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">epoch_loss</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;  reward=  &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">epoch_reward</span><span class="p">))</span>
    <span class="n">total_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_loss</span><span class="p">)</span>  
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>epoch_0:  loss=-434.15869140625  reward=  -94.21874237060547
epoch_1:  loss=-424.1404113769531  reward=  -91.69937896728516
epoch_2:  loss=-436.8798522949219  reward=  -93.18343353271484
epoch_3:  loss=-454.4273681640625  reward=  -96.57652282714844
epoch_4:  loss=-436.4529113769531  reward=  -91.76925659179688
epoch_5:  loss=-421.24530029296875  reward=  -87.33723449707031
epoch_6:  loss=-413.3312683105469  reward=  -84.89115142822266
epoch_7:  loss=-394.2191162109375  reward=  -79.93122863769531
epoch_8:  loss=-415.0520324707031  reward=  -83.29130554199219
epoch_9:  loss=-380.2655029296875  reward=  -75.64791870117188
epoch_10:  loss=-404.0414733886719  reward=  -78.71047973632812
epoch_11:  loss=-370.0225830078125  reward=  -74.467041015625
epoch_12:  loss=-403.89019775390625  reward=  -78.97952270507812
epoch_13:  loss=-400.32525634765625  reward=  -77.73628234863281
epoch_14:  loss=-380.1445617675781  reward=  -73.97552490234375
epoch_15:  loss=-391.7283020019531  reward=  -74.8330078125
epoch_16:  loss=-409.9129333496094  reward=  -76.5369644165039
epoch_17:  loss=-398.1524658203125  reward=  -73.23690032958984
epoch_18:  loss=-412.8946533203125  reward=  -75.6321029663086
epoch_19:  loss=-392.4568176269531  reward=  -70.35201263427734
epoch_20:  loss=-402.51251220703125  reward=  -71.76426696777344
epoch_21:  loss=-393.3529968261719  reward=  -68.99085235595703
epoch_22:  loss=-424.10772705078125  reward=  -74.88196563720703
epoch_23:  loss=-371.7626647949219  reward=  -62.756309509277344
epoch_24:  loss=-406.7032470703125  reward=  -69.5239028930664
epoch_25:  loss=-413.46826171875  reward=  -70.21016693115234
epoch_26:  loss=-381.4178771972656  reward=  -62.48395538330078
epoch_27:  loss=-393.3104553222656  reward=  -64.2697982788086
epoch_28:  loss=-411.4168395996094  reward=  -67.4195556640625
epoch_29:  loss=-402.0660705566406  reward=  -64.6007080078125
epoch_30:  loss=-411.00799560546875  reward=  -65.77066802978516
epoch_31:  loss=-404.57196044921875  reward=  -63.586524963378906
epoch_32:  loss=-396.587890625  reward=  -61.06828308105469
epoch_33:  loss=-375.3912658691406  reward=  -55.68218231201172
epoch_34:  loss=-379.1978759765625  reward=  -55.68901824951172
epoch_35:  loss=-385.91357421875  reward=  -56.388343811035156
epoch_36:  loss=-393.93780517578125  reward=  -57.38147735595703
epoch_37:  loss=-416.4791259765625  reward=  -61.48567199707031
epoch_38:  loss=-370.73846435546875  reward=  -50.73662567138672
epoch_39:  loss=-400.337890625  reward=  -56.4139404296875
epoch_40:  loss=-388.9174499511719  reward=  -53.15800476074219
epoch_41:  loss=-359.5585632324219  reward=  -45.974037170410156
epoch_42:  loss=-363.9505615234375  reward=  -46.14964294433594
epoch_43:  loss=-378.8984375  reward=  -48.61058807373047
epoch_44:  loss=-359.16448974609375  reward=  -43.544586181640625
epoch_45:  loss=-372.9488830566406  reward=  -45.768882751464844
epoch_46:  loss=-374.2965087890625  reward=  -45.270103454589844
epoch_47:  loss=-384.1467590332031  reward=  -46.62992858886719
epoch_48:  loss=-373.5057067871094  reward=  -43.53697204589844
epoch_49:  loss=-368.18255615234375  reward=  -41.583251953125
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="links">
<h2>Links<a class="headerlink" href="#links" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/lzzscl/KBGAN-KV_MemNN/tree/master/">https://github.com/lzzscl/KBGAN-KV_MemNN/tree/master</a></p>
<p><a class="reference external" href="https://dl.acm.org/doi/epdf/10.1145/3219819.3220004">Neural Memory Streaming Recommender Networks with Adversarial Training</a></p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "sparsh-ai/incremental-learning",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="T993858_Incremental_Collaborative_Filtering.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">Incremental Collaborative Filtering</p>
            </div>
        </a>
    </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Sparsh A.<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>